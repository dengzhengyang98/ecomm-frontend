name: Deploy Frontend (S3 to Amplify)

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch

jobs:
  deploy-s3:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Install jq
      # jq is needed to parse JSON output and extract the upload URL
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Prepare Frontend Artifact
      # Create a single ZIP file of all frontend files in the current directory
      run: |
        zip -r frontend-artifact.zip .

    - name: Create and Upload Deployment
      id: amplify_deploy
      run: |
        # 1. Create the deployment job and capture the upload URL and jobId
        DEPLOYMENT_INFO=$(aws amplify create-deployment \
          --app-id ${{ secrets.AMPLIFY_APP_ID }} \
          --branch-name ${{ secrets.AMPLIFY_BRANCH_NAME }})

        UPLOAD_URL=$(echo $DEPLOYMENT_INFO | jq -r '.uploadUrl')
        JOB_ID=$(echo $DEPLOYMENT_INFO | jq -r '.jobId')

        if [ -z "$JOB_ID" ] || [ -z "$UPLOAD_URL" ]; then
          echo "Error: Failed to retrieve upload URL or jobId from Amplify API."
          exit 1
        fi

        echo "Created Amplify Deployment Job ID: $JOB_ID"
        echo "Uploading artifact to: $UPLOAD_URL"

        # 2. Upload the zipped file directly to the temporary S3 URL using curl
        # Note: curl is used for direct upload because aws s3 cp/sync is not suitable here
        curl -X PUT -T frontend-artifact.zip "$UPLOAD_URL"

        # Pass the JOB_ID to the next step
        echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV


    - name: Start Amplify Deployment
      run: |
        # 3. Start the deployment using the job ID from the previous step
        aws amplify start-deployment \
          --app-id ${{ secrets.AMPLIFY_APP_ID }} \
          --branch-name ${{ secrets.AMPLIFY_BRANCH_NAME }} \
          --job-id ${{ env.JOB_ID }}